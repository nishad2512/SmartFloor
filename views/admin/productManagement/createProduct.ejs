<%- include("../../partials/admin-header.ejs") %>

    <body class="bg-background-light dark:bg-background-dark font-display text-[#141414] dark:text-white">
        <%- include("../../partials/flash.ejs") %>
            <div class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden">
                <div class="flex min-h-screen">
                    <%- include("../../partials/sidebar.ejs") %>
                        <main class="flex-1 p-6 lg:p-10">
                            <div class="max-w-4xl mx-auto">
                                <div class="flex flex-wrap justify-between gap-4 items-center mb-6">
                                    <div class="flex flex-col gap-1">
                                        <p
                                            class="text-[#141414] dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]">
                                            Add New Product
                                        </p>
                                        <p
                                            class="text-[#757575] dark:text-gray-400 text-base font-normal leading-normal">
                                            Fill in the details to create a new product.
                                        </p>
                                    </div>
                                </div>
                                <form action="/admin/products/create" method="post" enctype="multipart/form-data">
                                    <div class="flex flex-col gap-8">
                                        <div
                                            class="rounded-xl border border-[#e0e0e0] dark:border-primary/20 bg-white dark:bg-[#1f1f1f]">
                                            <div class="p-6 border-b border-[#e0e0e0] dark:border-primary/20">
                                                <h2 class="text-lg font-bold tracking-[-0.015em]">
                                                    Product Information
                                                </h2>
                                            </div>
                                            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div class="md:col-span-2">
                                                    <label
                                                        class="block text-sm font-medium text-[#141414] dark:text-white mb-2"
                                                        for="product-name">Product Name</label>
                                                    <input
                                                        class="w-full bg-transparent border-[#e0e0e0] dark:border-primary/20 rounded-lg focus:ring-primary focus:border-primary text-sm"
                                                        id="product-name" placeholder="e.g., Oak Hardwood Flooring"
                                                        type="text" name="name" />
                                                </div>
                                                <div>
                                                    <label
                                                        class="block text-sm font-medium text-[#141414] dark:text-white mb-2"
                                                        for="category">Category</label>
                                                    <select
                                                        class="w-full bg-transparent border-[#e0e0e0] dark:border-primary/20 rounded-lg focus:ring-primary focus:border-primary text-sm"
                                                        id="category" name="category">
                                                        <option disabled selected>Select a category</option>
                                                        <% categories.forEach(category=> { %>
                                                            <option>
                                                                <%= category.name %>
                                                            </option>
                                                            <% }) %>
                                                    </select>
                                                </div>
                                                <div class="md:col-span-2">
                                                    <label
                                                        class="block text-sm font-medium text-[#141414] dark:text-white mb-2"
                                                        for="description">Product Description</label>
                                                    <textarea
                                                        class="w-full bg-transparent border-[#e0e0e0] dark:border-primary/20 rounded-lg focus:ring-primary focus:border-primary text-sm"
                                                        id="description" placeholder="Describe the product details..."
                                                        rows="4" name="description"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                        <div
                                            class="rounded-xl border border-[#e0e0e0] dark:border-primary/20 bg-white dark:bg-[#1f1f1f]">
                                            <div class="p-6 border-b border-[#e0e0e0] dark:border-primary/20">
                                                <h2 class="text-lg font-bold tracking-[-0.015em]">
                                                    Product Images
                                                </h2>
                                            </div>
                                            <div class="p-6">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Product
                                                    Images (Min 3)</label>
                                                <input type="file" name="images" multiple accept="image/*"
                                                    class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                                                    required onchange="previewImages(event)" id="image-input">
                                                <small class="text-gray-500">You can select multiple files at
                                                    once.</small>

                                                <div id="image-preview" class="flex gap-2 mt-4 overflow-x-auto p-2">
                                                </div>
                                            </div>
                                        </div>
                                        <div
                                            class="rounded-xl border border-[#e0e0e0] dark:border-primary/20 bg-white dark:bg-[#1f1f1f]">
                                            <div
                                                class="p-6 border-b border-[#e0e0e0] dark:border-primary/20 flex justify-between items-center">
                                                <div>
                                                    <h2 class="text-lg font-bold tracking-[-0.015em]">
                                                        Product Variants
                                                    </h2>
                                                    <p class="text-sm text-[#757575] dark:text-gray-400 mt-1">
                                                        Specify different sizes for this
                                                        product.
                                                    </p>
                                                </div>
                                                <button type="button" onclick="addVariant()"
                                                    class="flex items-center gap-2 bg-primary/5 dark:bg-primary/20 text-primary dark:text-white font-medium px-4 py-2 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/30 text-sm">
                                                    <span class="material-symbols-outlined text-lg">add</span>
                                                    Add Size
                                                </button>
                                            </div>
                                            <div class="p-6 space-y-4">
                                                <div
                                                    class="grid grid-cols-[1fr_1fr_1fr_auto] gap-4 items-center pb-2 border-b border-transparent">
                                                    <label
                                                        class="text-xs font-medium text-[#757575] dark:text-gray-400">Size
                                                        (e.g., 6" x 48")</label>
                                                    <label
                                                        class="text-xs font-medium text-[#757575] dark:text-gray-400 text-center">Stock</label>
                                                    <label
                                                        class="text-xs font-medium text-[#757575] dark:text-gray-400 text-center">Price</label>
                                                    <div class="w-8"></div>
                                                </div>
                                                <div id="variant-container"
                                                    class="grid grid-cols-[1fr_1fr_1fr_auto] gap-4 items-center">
                                                    <input
                                                        class="w-full bg-transparent border-[#e0e0e0] dark:border-primary/20 rounded-lg focus:ring-primary focus:border-primary text-sm"
                                                        placeholder='eg: 6" x 48"' type="text" name="size" />
                                                    <input
                                                        class="w-full bg-transparent border-[#e0e0e0] dark:border-primary/20 rounded-lg focus:ring-primary focus:border-primary text-sm text-center"
                                                        placeholder="eg: 50" type="number" name="stock" />
                                                    <input
                                                        class="w-full bg-transparent border-[#e0e0e0] dark:border-primary/20 rounded-lg focus:ring-primary focus:border-primary text-sm text-center"
                                                        placeholder="eg: $5.99" type="text" name="price" />
                                                    <button
                                                        class="p-2 text-[#757575] dark:text-gray-400 hover:text-red-500 hover:bg-gray-100 dark:hover:bg-primary/30 rounded-full">
                                                        <span class="material-symbols-outlined text-xl">delete</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-8 flex justify-end gap-4">
                                        <button
                                            class="font-medium px-6 py-2.5 rounded-lg border border-[#e0e0e0] dark:border-primary/20 hover:bg-gray-100 dark:hover:bg-primary/20">
                                            Cancel
                                        </button>
                                        <button type="submit"
                                            class="bg-primary text-white font-medium px-6 py-2.5 rounded-lg hover:opacity-90">
                                            Save Product
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </main>
                </div>
            </div>
            <script>
                let currentFiles = new DataTransfer();

                function previewImages(event) {
                    const files = event.target.files;

                    // Reset currentFiles to match the new selection (standard input behavior)
                    // If you wanted to accumulate, you'd skip this and just append.
                    currentFiles = new DataTransfer();

                    Array.from(files).forEach(file => {
                        currentFiles.items.add(file);
                    });

                    renderPreviews();
                }

                function renderPreviews() {
                    const previewContainer = document.getElementById('image-preview');
                    previewContainer.innerHTML = ''; // Clear previous
                    previewContainer.className = "flex gap-2 mt-4 overflow-x-auto p-2"; // Add padding to prevent clipping

                    Array.from(currentFiles.files).forEach((file, index) => {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const div = document.createElement('div');
                            div.className = "relative group shrink-0"; // shrink-0 to prevent squishing in flex container

                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = "h-20 w-20 object-cover rounded border";

                            const btn = document.createElement('button');
                            btn.type = "button";
                            // Changed position to top-1 right-1 to be inside the image area
                            btn.className = "absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity shadow-sm hover:bg-red-600 z-10";
                            btn.innerHTML = '<span class="material-symbols-outlined text-[10px] font-bold block">close</span>';
                            btn.onclick = (e) => {
                                e.preventDefault();
                                removeImage(index);
                            };

                            div.appendChild(img);
                            div.appendChild(btn);
                            previewContainer.appendChild(div);
                        }
                        reader.readAsDataURL(file);
                    });
                }

                function removeImage(index) {
                    const newDt = new DataTransfer();
                    Array.from(currentFiles.files).forEach((file, i) => {
                        if (i !== index) newDt.items.add(file);
                    });
                    currentFiles = newDt;

                    // Update the actual input
                    document.getElementById('image-input').files = currentFiles.files;

                    renderPreviews();
                }

                function addVariant() {
                    const container = document.getElementById('variant-container');
                    const newRow = document.createElement('div');
                    newRow.className = "grid grid-cols-[1fr_1fr_1fr_auto] gap-4 items-center";
                    newRow.innerHTML = `
                    <input
                        class="w-full bg-transparent border-[#e0e0e0] dark:border-primary/20 rounded-lg focus:ring-primary focus:border-primary text-sm"
                        placeholder='eg: 6" x 48"'
                        type="text"
                        name="size"
                    />
                    <input
                        class="w-full bg-transparent border-[#e0e0e0] dark:border-primary/20 rounded-lg focus:ring-primary focus:border-primary text-sm text-center"
                        placeholder="eg: 50"
                        type="number"
                        name="stock"
                    />
                    <input
                        class="w-full bg-transparent border-[#e0e0e0] dark:border-primary/20 rounded-lg focus:ring-primary focus:border-primary text-sm text-center"
                        placeholder="eg: $5.99"
                        type="text"
                        name="price"
                    />
                    <button
                        class="p-2 text-[#757575] dark:text-gray-400 hover:text-red-500 hover:bg-gray-100 dark:hover:bg-primary/30 rounded-full"
                    >
                        <span
                            class="material-symbols-outlined text-xl"
                            >delete</span
                        >
                    </button>
                `;
                    container.parentNode.insertBefore(newRow, container.nextSibling);
                }
            </script>
    </body>

    </html>